#!/bin/sh

if [ "$#" -ne 1 ]; then
  echo "Usage: $0 PATH" >&2
  exit 1
fi

ALLOWED_CHARS="a-zA-z0-9\-_."
DIR=$(dirname "$1")
NAME=$(basename "$1" ".*" | \
  tr '[:upper:]' '[:lower:]' | \
  sed "s/[^${ALLOWED_CHARS}]/_/g" | \
  sed "s/^\d\+_*//")

i=1
name="$(printf "%04d" $i)_${NAME}"

while [ -f "$DIR/$name" ]; do
  i=$((i + 1))
  name="$(printf "%04d" $i)_${NAME}"
done

echo "${DIR}/${name}"
